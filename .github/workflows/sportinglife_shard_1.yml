name: SportingLife Clearance Shard 1/3

concurrency:
  group: econoplus-sportinglife-publish
  cancel-in-progress: false

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    env:
      SHARD_INDEX: '1'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Sporting Life scraper
        env:
          TOTAL_SHARDS: '3'
          MAX_PAGES: '50'
          SAVE_DEBUG_HTML: 'true'
        run: |
          node scraper_sportinglife.js

      - name: Upload debug HTML (if present)
        uses: actions/upload-artifact@v4
        with:
          name: sportinglife-debug-shard-1
          path: outputs/debug/sportinglife_page1.html
          if-no-files-found: ignore

      - name: Checkout econoplus
        uses: actions/checkout@v4
        with:
          repository: Olivier-cousineau/econoplus
          token: ${{ secrets.ECONOPLUS_PUSH_TOKEN }}
          path: _econoplus
          ref: main

      - name: Copy Sporting Life data into econoplus
        run: |
          mkdir -p _econoplus/public/sportinglife
          rsync -av --delete public/sportinglife/ _econoplus/public/sportinglife/
          cp -f data/sportinglife_stores.json _econoplus/public/sportinglife/stores.json

      - name: Commit & push to econoplus (push-safe)
        env:
          SHARD_INDEX: ${{ env.SHARD_INDEX }}
        run: |
          set -euo pipefail
          cd _econoplus
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin main
          git checkout main
          git reset --hard origin/main

          git add public/sportinglife || true
          if git diff --cached --quiet; then
            echo "No changes to push to econoplus."
            exit 0
          fi

          git commit -m "chore: update sportinglife shard ${SHARD_INDEX} data"

          for attempt in 1 2 3; do
            if git push origin main; then
              echo "Push OK"
              exit 0
            fi
            echo "Push rejected (attempt ${attempt}). Re-sync and retry..."
            git fetch origin main
            git reset --hard origin/main
            git add public/sportinglife || true
            if git diff --cached --quiet; then
              echo "After resync, nothing to push."
              exit 0
            fi
            git commit -m "chore: update sportinglife shard ${SHARD_INDEX} data"
          done

          echo "Push failed after 3 attempts."
          exit 1
